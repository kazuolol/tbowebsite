name: Configure Cloudflare (Domains + Redirects)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  configure:
    runs-on: ubuntu-latest
    steps:
      - name: Configure Cloudflare (Pages Domains + Redirect Rule)
        env:
          CF_API_BASE: https://api.cloudflare.com/client/v4
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CF_PAGES_PROJECT_NAME: ${{ secrets.CF_PAGES_PROJECT_NAME }}
          APEX_DOMAIN: thebigone.gg
          WWW_DOMAIN: www.thebigone.gg
        run: |
          set -euo pipefail

          if [ -z "${CF_API_TOKEN:-}" ]; then
            echo "Missing secret: CLOUDFLARE_API_TOKEN" >&2
            exit 1
          fi
          if [ -z "${CF_ACCOUNT_ID:-}" ]; then
            echo "Missing secret: CLOUDFLARE_ACCOUNT_ID" >&2
            exit 1
          fi
          if [ -z "${CF_PAGES_PROJECT_NAME:-}" ]; then
            echo "Missing secret: CF_PAGES_PROJECT_NAME" >&2
            exit 1
          fi

          echo "Resolving zone id for: ${APEX_DOMAIN}"
          zone_resp="$(curl -sS -H "Authorization: Bearer ${CF_API_TOKEN}" \
            "${CF_API_BASE}/zones?name=${APEX_DOMAIN}")"

          ok="$(echo "${zone_resp}" | jq -r '.success')"
          if [ "${ok}" != "true" ]; then
            echo "${zone_resp}" | jq .
            echo "Failed to resolve zone by name: ${APEX_DOMAIN}" >&2
            exit 1
          fi

          CF_ZONE_ID="$(echo "${zone_resp}" | jq -r '.result[0].id // empty')"
          if [ -z "${CF_ZONE_ID}" ]; then
            echo "${zone_resp}" | jq .
            echo "Zone not found (or no access): ${APEX_DOMAIN}" >&2
            exit 1
          fi

          ZONE_ACCOUNT_ID="$(echo "${zone_resp}" | jq -r '.result[0].account.id // empty')"
          ZONE_ACCOUNT_NAME="$(echo "${zone_resp}" | jq -r '.result[0].account.name // empty')"
          echo "Zone account: ${ZONE_ACCOUNT_NAME} (${ZONE_ACCOUNT_ID})"

          if [ -n "${ZONE_ACCOUNT_ID}" ] && [ "${ZONE_ACCOUNT_ID}" != "${CF_ACCOUNT_ID}" ]; then
            echo "Zone account mismatch: the zone is not in the same Cloudflare account as CLOUDFLARE_ACCOUNT_ID." >&2
            echo "Pages custom domains will stay pending (and can show Error 1014) until the zone and Pages project are in the same account." >&2
            exit 1
          fi
          echo "Zone id: ${CF_ZONE_ID}"

          echo "Ensuring Pages project exists: ${CF_PAGES_PROJECT_NAME}"
          http_code="$(curl -sS -o project.json -w "%{http_code}" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            "${CF_API_BASE}/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PAGES_PROJECT_NAME}")"

          if [ "${http_code}" = "200" ]; then
            ok="$(jq -r '.success' project.json)"
            if [ "${ok}" != "true" ]; then
              cat project.json | jq .
              echo "Failed to fetch Pages project." >&2
              exit 1
            fi
          elif [ "${http_code}" = "404" ]; then
            echo "Pages project not found; creating: ${CF_PAGES_PROJECT_NAME}"
            create_resp="$(curl -sS -X POST \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "$(jq -n --arg name "${CF_PAGES_PROJECT_NAME}" --arg branch "master" '{name: $name, production_branch: $branch}')" \
              "${CF_API_BASE}/accounts/${CF_ACCOUNT_ID}/pages/projects")"

            ok="$(echo "${create_resp}" | jq -r '.success')"
            if [ "${ok}" != "true" ]; then
              echo "${create_resp}" | jq .
              echo "Failed to create Pages project: ${CF_PAGES_PROJECT_NAME}" >&2
              exit 1
            fi
          else
            echo "Unexpected status when fetching Pages project: ${http_code}" >&2
            cat project.json | jq .
            exit 1
          fi

          echo "Attaching custom domains to Pages project..."
          list_resp="$(curl -sS -H "Authorization: Bearer ${CF_API_TOKEN}" \
            "${CF_API_BASE}/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PAGES_PROJECT_NAME}/domains")"

          ok="$(echo "${list_resp}" | jq -r '.success')"
          if [ "${ok}" != "true" ]; then
            echo "${list_resp}" | jq .
            echo "Failed to list Pages domains." >&2
            exit 1
          fi

          echo "Pages domains (current):"
          echo "${list_resp}" | jq -r '.result[]? | "\(.name) status=\(.status // "")"'

          ensure_domain () {
            local domain="$1"
            local already
            already="$(echo "${list_resp}" | jq -r --arg d "${domain}" '.result[]?.name | select(. == $d)')"
            if [ -n "${already}" ]; then
              echo "Pages domain already attached: ${domain}"
              return 0
            fi

            echo "Attaching Pages domain: ${domain}"
            create_resp="$(curl -sS -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "$(jq -n --arg name "${domain}" '{name: $name}')" \
              "${CF_API_BASE}/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PAGES_PROJECT_NAME}/domains")"

            ok="$(echo "${create_resp}" | jq -r '.success')"
            if [ "${ok}" != "true" ]; then
              echo "${create_resp}" | jq .
              echo "Failed to attach Pages domain: ${domain}" >&2
              exit 1
            fi

            status="$(echo "${create_resp}" | jq -r '.result.status // empty')"
            echo "Attached ${domain} (status=${status})"
          }

          ensure_domain "${APEX_DOMAIN}"
          ensure_domain "${WWW_DOMAIN}"

          echo "Ensuring DNS records point to Pages..."
          PAGES_TARGET="${CF_PAGES_PROJECT_NAME}.pages.dev"

          ensure_pages_cname () {
            local record_name="$1"
            local target="$2"
            local desired_proxied="$3" # "true" or "false"

            echo "Ensuring CNAME ${record_name} -> ${target} (proxied=${desired_proxied})"

            resp="$(curl -sS -H "Authorization: Bearer ${CF_API_TOKEN}" \
              "${CF_API_BASE}/zones/${CF_ZONE_ID}/dns_records?name=${record_name}")"

            ok="$(echo "${resp}" | jq -r '.success')"
            if [ "${ok}" != "true" ]; then
              echo "${resp}" | jq .
              echo "Failed to list DNS records for: ${record_name}" >&2
              exit 1
            fi

            existing_cname_id="$(echo "${resp}" | jq -r --arg name "${record_name}" '.result[]? | select(.type == "CNAME" and .name == $name) | .id' | head -n 1)"
            existing_cname_content="$(echo "${resp}" | jq -r --arg name "${record_name}" '.result[]? | select(.type == "CNAME" and .name == $name) | .content' | head -n 1)"
            existing_cname_proxied="$(echo "${resp}" | jq -r --arg name "${record_name}" '.result[]? | select(.type == "CNAME" and .name == $name) | .proxied' | head -n 1)"

            if [ -n "${existing_cname_id}" ]; then
              if [ "${existing_cname_content}" = "${target}" ] && [ "${existing_cname_proxied}" = "${desired_proxied}" ]; then
                echo "CNAME already correct: ${record_name}"
                return 0
              fi

              echo "Updating CNAME: ${record_name}"
              update_body="$(jq -n \
                --arg name "${record_name}" \
                --arg content "${target}" \
                --argjson proxied "${desired_proxied}" \
                '{type:"CNAME", name:$name, content:$content, ttl:1, proxied:$proxied}')"
              update_resp="$(curl -sS -X PUT \
                -H "Authorization: Bearer ${CF_API_TOKEN}" \
                -H "Content-Type: application/json" \
                --data "${update_body}" \
                "${CF_API_BASE}/zones/${CF_ZONE_ID}/dns_records/${existing_cname_id}")"

              ok="$(echo "${update_resp}" | jq -r '.success')"
              if [ "${ok}" != "true" ]; then
                echo "${update_resp}" | jq .
                echo "Failed to update CNAME for: ${record_name}" >&2
                exit 1
              fi

              echo "Updated CNAME: ${record_name}"
              return 0
            fi

            # No CNAME yet. If an A/AAAA exists for this name, remove it and replace with CNAME.
            to_delete_ids="$(echo "${resp}" | jq -r --arg name "${record_name}" '.result[]? | select(.name == $name and (.type == "A" or .type == "AAAA")) | .id')"
            if [ -n "${to_delete_ids}" ]; then
              echo "Removing existing A/AAAA records for: ${record_name}"
              echo "${to_delete_ids}" | while read -r id; do
                [ -z "${id}" ] && continue
                del_resp="$(curl -sS -X DELETE \
                  -H "Authorization: Bearer ${CF_API_TOKEN}" \
                  "${CF_API_BASE}/zones/${CF_ZONE_ID}/dns_records/${id}")"
                ok="$(echo "${del_resp}" | jq -r '.success')"
                if [ "${ok}" != "true" ]; then
                  echo "${del_resp}" | jq .
                  echo "Failed to delete DNS record id=${id} for ${record_name}" >&2
                  exit 1
                fi
              done
            fi

            echo "Creating CNAME: ${record_name}"
            create_body="$(jq -n \
              --arg name "${record_name}" \
              --arg content "${target}" \
              --argjson proxied "${desired_proxied}" \
              '{type:"CNAME", name:$name, content:$content, ttl:1, proxied:$proxied}')"
            create_resp="$(curl -sS -X POST \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "${create_body}" \
              "${CF_API_BASE}/zones/${CF_ZONE_ID}/dns_records")"

            ok="$(echo "${create_resp}" | jq -r '.success')"
            if [ "${ok}" != "true" ]; then
              echo "${create_resp}" | jq .
              echo "Failed to create CNAME for: ${record_name}" >&2
              exit 1
            fi

            echo "Created CNAME: ${record_name}"
          }

          ensure_redirect_a () {
            local record_name="$1"
            local ip="$2"
            local desired_proxied="$3" # "true" or "false"

            echo "Ensuring A ${record_name} -> ${ip} (proxied=${desired_proxied})"

            resp="$(curl -sS -H "Authorization: Bearer ${CF_API_TOKEN}" \
              "${CF_API_BASE}/zones/${CF_ZONE_ID}/dns_records?name=${record_name}")"

            ok="$(echo "${resp}" | jq -r '.success')"
            if [ "${ok}" != "true" ]; then
              echo "${resp}" | jq .
              echo "Failed to list DNS records for: ${record_name}" >&2
              exit 1
            fi

            existing_a_id="$(echo "${resp}" | jq -r --arg name "${record_name}" '.result[]? | select(.type == "A" and .name == $name) | .id' | head -n 1)"
            existing_a_content="$(echo "${resp}" | jq -r --arg name "${record_name}" '.result[]? | select(.type == "A" and .name == $name) | .content' | head -n 1)"
            existing_a_proxied="$(echo "${resp}" | jq -r --arg name "${record_name}" '.result[]? | select(.type == "A" and .name == $name) | .proxied' | head -n 1)"

            if [ -n "${existing_a_id}" ]; then
              if [ "${existing_a_content}" = "${ip}" ] && [ "${existing_a_proxied}" = "${desired_proxied}" ]; then
                echo "A record already correct: ${record_name}"
                return 0
              fi

              echo "Updating A record: ${record_name}"
              update_body="$(jq -n \
                --arg name "${record_name}" \
                --arg content "${ip}" \
                --argjson proxied "${desired_proxied}" \
                '{type:"A", name:$name, content:$content, ttl:1, proxied:$proxied}')"
              update_resp="$(curl -sS -X PUT \
                -H "Authorization: Bearer ${CF_API_TOKEN}" \
                -H "Content-Type: application/json" \
                --data "${update_body}" \
                "${CF_API_BASE}/zones/${CF_ZONE_ID}/dns_records/${existing_a_id}")"

              ok="$(echo "${update_resp}" | jq -r '.success')"
              if [ "${ok}" != "true" ]; then
                echo "${update_resp}" | jq .
                echo "Failed to update A record for: ${record_name}" >&2
                exit 1
              fi

              echo "Updated A record: ${record_name}"
              return 0
            fi

            # Ensure this hostname is not a CNAME, and avoid any AAAA bypassing proxy.
            to_delete_ids="$(echo "${resp}" | jq -r --arg name "${record_name}" '.result[]? | select(.name == $name and (.type == "CNAME" or .type == "AAAA")) | .id')"
            if [ -n "${to_delete_ids}" ]; then
              echo "Removing existing CNAME/AAAA records for: ${record_name}"
              echo "${to_delete_ids}" | while read -r id; do
                [ -z "${id}" ] && continue
                del_resp="$(curl -sS -X DELETE \
                  -H "Authorization: Bearer ${CF_API_TOKEN}" \
                  "${CF_API_BASE}/zones/${CF_ZONE_ID}/dns_records/${id}")"
                ok="$(echo "${del_resp}" | jq -r '.success')"
                if [ "${ok}" != "true" ]; then
                  echo "${del_resp}" | jq .
                  echo "Failed to delete DNS record id=${id} for ${record_name}" >&2
                  exit 1
                fi
              done
            fi

            echo "Creating A record: ${record_name}"
            create_body="$(jq -n \
              --arg name "${record_name}" \
              --arg content "${ip}" \
              --argjson proxied "${desired_proxied}" \
              '{type:"A", name:$name, content:$content, ttl:1, proxied:$proxied}')"
            create_resp="$(curl -sS -X POST \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "${create_body}" \
              "${CF_API_BASE}/zones/${CF_ZONE_ID}/dns_records")"

            ok="$(echo "${create_resp}" | jq -r '.success')"
            if [ "${ok}" != "true" ]; then
              echo "${create_resp}" | jq .
              echo "Failed to create A record for: ${record_name}" >&2
              exit 1
            fi

            echo "Created A record: ${record_name}"
          }

          # Pages custom domain CNAMEs can trigger Error 1014 when proxied. Keep apex DNS-only,
          # and use a proxied placeholder A-record for WWW so the redirect rule can run.
          ensure_pages_cname "${APEX_DOMAIN}" "${PAGES_TARGET}" false
          ensure_redirect_a "${WWW_DOMAIN}" "192.0.2.1" true

          echo "Ensuring redirect rule: ${WWW_DOMAIN} -> ${APEX_DOMAIN}"
          entrypoint_url="${CF_API_BASE}/zones/${CF_ZONE_ID}/rulesets/phases/http_request_dynamic_redirect/entrypoint"
          http_code="$(curl -sS -o entrypoint.json -w "%{http_code}" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            "${entrypoint_url}")"

          desired_rule="$(jq -n \
            --arg www "${WWW_DOMAIN}" \
            --arg apex "${APEX_DOMAIN}" \
            '{
              ref: "redirect_www_to_apex",
              description: ("Redirect " + $www + " to " + $apex),
              expression: ("(http.host eq \"" + $www + "\")"),
              action: "redirect",
              action_parameters: {
                from_value: {
                  target_url: {
                    expression: ("concat(\"https://" + $apex + "\", http.request.uri.path)")
                  },
                  status_code: 301,
                  preserve_query_string: true
                }
              },
              enabled: true
            }')"

          if [ "${http_code}" = "404" ]; then
            echo "No redirect entrypoint ruleset exists yet; creating."
            create_body="$(jq -n --argjson rule "${desired_rule}" '{rules: [$rule]}')"
            resp="$(curl -sS -X PUT \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "${create_body}" \
              "${entrypoint_url}")"

            ok="$(echo "${resp}" | jq -r '.success')"
            if [ "${ok}" != "true" ]; then
              echo "${resp}" | jq .
              echo "Failed to create redirect entrypoint ruleset." >&2
              exit 1
            fi
            echo "Created redirect entrypoint ruleset."
            exit 0
          fi

          if [ "${http_code}" != "200" ]; then
            echo "Unexpected status when fetching entrypoint ruleset: ${http_code}" >&2
            cat entrypoint.json | jq .
            exit 1
          fi

          existing_ok="$(jq -r '.success' entrypoint.json)"
          if [ "${existing_ok}" != "true" ]; then
            cat entrypoint.json | jq .
            echo "Failed to fetch redirect entrypoint ruleset." >&2
            exit 1
          fi

          ruleset_id="$(jq -r '.result.id // empty' entrypoint.json)"
          if [ -z "${ruleset_id}" ]; then
            cat entrypoint.json | jq .
            echo "No ruleset id found in entrypoint response." >&2
            exit 1
          fi

          already="$(jq -r '.result.rules[]?.ref | select(. == "redirect_www_to_apex")' entrypoint.json)"
          if [ -n "${already}" ]; then
            echo "Redirect rule already present (ref=redirect_www_to_apex)."
            exit 0
          fi

          echo "Adding redirect rule to ruleset: ${ruleset_id}"
          add_url="${CF_API_BASE}/zones/${CF_ZONE_ID}/rulesets/${ruleset_id}/rules"
          add_resp="$(curl -sS -X POST \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data "${desired_rule}" \
            "${add_url}")"

          ok="$(echo "${add_resp}" | jq -r '.success')"
          if [ "${ok}" != "true" ]; then
            echo "${add_resp}" | jq .
            echo "Failed to add redirect rule." >&2
            exit 1
          fi

          echo "Added redirect rule."
