name: Deploy To Cloudflare Pages

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

concurrency:
  group: cloudflare-pages
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Build
        env:
          # Vite build-time configuration (baked into the bundle).
          # Defaults keep production usable even before the backend API is deployed.
          VITE_EARLY_ACCESS_API_MODE: ${{ vars.VITE_EARLY_ACCESS_API_MODE || 'mock' }}
          VITE_EARLY_ACCESS_API_BASE_URL: ${{ vars.VITE_EARLY_ACCESS_API_BASE_URL || '' }}
          VITE_EARLY_ACCESS_REQUIRE_TELEGRAM_VERIFICATION: ${{ vars.VITE_EARLY_ACCESS_REQUIRE_TELEGRAM_VERIFICATION || 'true' }}
        run: npm run build

      - name: Ensure Pages Project Exists
        env:
          CF_API_BASE: https://api.cloudflare.com/client/v4
          # Prefer a scoped API token. Fallback supports a legacy secret name.
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN || secrets.CLOUDFLARE_API_KEY }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CF_PAGES_PROJECT_NAME: ${{ secrets.CF_PAGES_PROJECT_NAME }}
        run: |
          set -euo pipefail

          http_code="$(curl -sS -o project.json -w "%{http_code}" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            "${CF_API_BASE}/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PAGES_PROJECT_NAME}")"

          if [ "${http_code}" = "200" ]; then
            ok="$(jq -r '.success' project.json)"
            if [ "${ok}" != "true" ]; then
              cat project.json | jq .
              echo "Failed to fetch Pages project." >&2
              exit 1
            fi
            echo "Pages project exists: ${CF_PAGES_PROJECT_NAME}"
            exit 0
          fi

          if [ "${http_code}" != "404" ]; then
            echo "Unexpected status when fetching Pages project: ${http_code}" >&2
            cat project.json | jq .
            exit 1
          fi

          echo "Pages project not found; creating: ${CF_PAGES_PROJECT_NAME}"
          create_resp="$(curl -sS -X POST \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data "$(jq -n --arg name "${CF_PAGES_PROJECT_NAME}" --arg branch "master" '{name: $name, production_branch: $branch}')" \
            "${CF_API_BASE}/accounts/${CF_ACCOUNT_ID}/pages/projects")"

          ok="$(echo "${create_resp}" | jq -r '.success')"
          if [ "${ok}" != "true" ]; then
            echo "${create_resp}" | jq .
            echo "Failed to create Pages project: ${CF_PAGES_PROJECT_NAME}" >&2
            exit 1
          fi

          echo "Created Pages project: ${CF_PAGES_PROJECT_NAME}"

      - name: Publish
        uses: cloudflare/pages-action@v1
        with:
          # Prefer a scoped API token. Fallback supports a legacy secret name.
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN || secrets.CLOUDFLARE_API_KEY }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ secrets.CF_PAGES_PROJECT_NAME }}
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
